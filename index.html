<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Dreamcatcher</title>
    <link rel="stylesheet" href="base.css">

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.25.3/moment.min.js"
      integrity="sha256-C66CaAImteEKZPYvgng9j10J/45e9sAuZyfPYCwp4gE="
      crossorigin="anonymous">
    </script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js"
      integrity="sha256-oI+elz+sIm+jpn8F/qEspKoKveTc5uKeFHNNVexe6d8="
      crossorigin="anonymous">
    </script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.3.0/frappe-gantt.min.js"
      integrity="sha256-YA6lue6HOUrphxAbwHtvGF84CE76RcfTyBYvlEU3u6U="
      crossorigin="anonymous">
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.3.0/frappe-gantt.css"
      integrity="sha256-m2zScNAG4lg2ENuIJ2CStnLf9YK0KMAkuZly2YSz8B0="
      crossorigin="anonymous"/>
</head>

<body>

  <section class="main">

    <div class="chart_and_controls">
      <div class="gantt-container">
        <svg id="gantt"></svg>
      </div>

      <div class="controls">
        <select onchange="change_gantt_view(this.value);">
          <option value="Day">Days</option>
          <option selected value="Week">Weeks</option>
          <option value="Month">Months</option>
        </select>

        <button onclick="add_task()">New Task</button>
      </div>
    </div>

    <div class="task_properties">
      <div>
        <label for="task_name">Name:</label>
        <input type="text" id="task_name" name="name"
               onchange="update_task(this)">
      </div>
      <div>
        <label for="start_date">Start Date:</label>
        <input type="date" id="description_start_date" name="start_date"
               onchange="update_task(this)">
      </div>
      <div>
        <label for="end_date">End Date:</label>
        <input type="date" id="description_end_date" name="end_date"
               onchange="update_task(this)">
      </div>
      <div>
        <button onclick="delete_task()">Delete Task</button>
      </div>
      <hr>
      <div class="task_description">
        <!-- todo: use css to fill to bottom -->
        <textarea id="description" rows="15"
                  onchange="update_task(this);">
          Description
        </textarea>
      </div>
    </div>
  </section>

  <script>
    var tasks = [
        {
            name: 'Vacation',
            start: moment().format("YYYY-MM-DD"), //todo: avoid casting date to string?
            end: moment().add(30, 'days').format("YYYY-MM-DD"),
            description: "go to hell"
        }
    ];

    var active_task_id = null;

    var gantt = new Gantt("#gantt", tasks, {
        view_modes: ['Day', 'Week', 'Month'],
        view_mode: 'Week',
        on_click: gantt_on_click, // scope?
        on_date_change: gantt_on_date_change // doesn't work?
    });

    function change_gantt_view(view_mode) {
        gantt.change_view_mode(view_mode);
    }

    function gantt_on_click(task) {
        active_task_id = task.id;
        document.getElementById("task_name").value = task.name;
        document.getElementById("description_start_date").value = task.start;
        document.getElementById("description_end_date").value = task.end;
        document.getElementById("description").value = task.description;
    }

    function gantt_on_date_change(task, start, date) {
        //todo: merge with gantt_on_click?
        active_task_id = task.id;
        document.getElementById("description_start_date").value = start;
        document.getElementById("description_end_date").value = end;
    }

    function add_task() {
        var tasks = gantt.tasks;

        var new_task = {
            name: 'Visit New Place',
            start: moment().format("YYYY-MM-DD"),
            end: moment().add(7, 'days').format("YYYY-MM-DD"),
            description: ''
        };

        tasks.push(new_task);
        gantt.refresh(tasks);
    }


    function update_task(input_obj) {
        if ( active_task_id == null ) return;

        // todo: use gantt.get_task(id)?
        var tasks = gantt.tasks;
        var idx = tasks.findIndex( x => {return x.id === active_task_id} );

        // todo: simplify; pass task field as arg?
        if ( input_obj.id == "description_end_date" ){
            tasks[idx].end = input_obj.value;
        } else if ( input_obj.id == "description_start_date" ){
            tasks[idx].start = input_obj.value;
        } else if ( input_obj.id == "task_name" ){
            tasks[idx].name = input_obj.value;
        } else if ( input_obj.id == "description" ){
            tasks[idx].description = input_obj.value;
        }

        gantt.refresh(tasks);
    }

    function delete_task() {
        if ( active_task_id == null ) return;

        var tasks = gantt.tasks;
        var idx = tasks.findIndex( x => {return x.id === active_task_id} );
        if (idx > -1) {
            tasks.splice(idx, 1);
        }

        document.getElementById("task_name").value = null;
        document.getElementById("description_start_date").value = null;
        document.getElementById("description_end_date").value = null;
        document.getElementById("description").value = null;

        active_task_id = null;
        gantt.refresh(tasks);
    }

  </script>

</body>
</html>
